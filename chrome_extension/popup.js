noInfoFoodName = "no info"

food_data = {"onion":{"impact":0.17,"replacement":""},"celery":{"impact":0.18,"replacement":""},"potatoes":{"impact":0.18,"replacement":""},"carrots":{"impact":0.2,"replacement":""},"zucchini":{"impact":0.21,"replacement":""},"button squash":{"impact":0.21,"replacement":""},"beetroot":{"impact":0.24,"replacement":""},"pumpkins":{"impact":0.25,"replacement":""},"rockmelon":{"impact":0.25,"replacement":""},"cantelope":{"impact":0.25,"replacement":""},"plake beans":{"impact":0.26,"replacement":""},"limes":{"impact":0.26,"replacement":""},"lemons":{"impact":0.26,"replacement":""},"mushrooms":{"impact":0.27,"replacement":""},"guavas":{"impact":0.28,"replacement":""},"apples":{"impact":0.29,"replacement":""},"rutabage":{"impact":0.29,"replacement":""},"swedes":{"impact":0.29,"replacement":""},"pears":{"impact":0.31,"replacement":""},"quinces":{"impact":0.31,"replacement":""},"green beans":{"impact":0.31,"replacement":""},"watermelons":{"impact":0.32,"replacement":""},"dates":{"impact":0.32,"replacement":""},"orange":{"impact":0.33,"replacement":""},"kiwi":{"impact":0.36,"replacement":""},"broccoli":{"impact":0.36,"replacement":""},"cauliflowers":{"impact":0.36,"replacement":""},"grapes":{"impact":0.37,"replacement":""},"oats":{"impact":0.38,"replacement":""},"rye":{"impact":0.38,"replacement":""},"peas":{"impact":0.38,"replacement":""},"cherries":{"impact":0.39,"replacement":""},"gigante beans":{"impact":0.39,"replacement":""},"butter beans":{"impact":0.39,"replacement":""},"almond milk":{"impact":0.42,"replacement":""},"coconut milk":{"impact":0.42,"replacement":""},"nectarines":{"impact":0.43,"replacement":""},"peaches":{"impact":0.43,"replacement":""},"figs":{"impact":0.43,"replacement":""},"barley":{"impact":0.43,"replacement":""},"apricot":{"impact":0.43,"replacement":""},"chestnuts":{"impact":0.43,"replacement":""},"beans":{"impact":0.43,"replacement":""},"mandarin":{"impact":0.45,"replacement":""},"tomatoes":{"impact":0.45,"replacement":""},"corn":{"impact":0.47,"replacement":""},"maize":{"impact":0.47,"replacement":""},"fennel":{"impact":0.48,"replacement":""},"artichokes":{"impact":0.48,"replacement":""},"cowpeas":{"impact":0.49,"replacement":""},"soybean":{"impact":0.49,"replacement":""},"pineapples":{"impact":0.5,"replacement":""},"melons":{"impact":0.51,"replacement":""},"pomelo":{"impact":0.51,"replacement":""},"grapefruit":{"impact":0.51,"replacement":""},"tangerines":{"impact":0.51,"replacement":""},"mandarins":{"impact":0.51,"replacement":""},"wheat":{"impact":0.52,"replacement":""},"flour":{"impact":0.52,"replacement":""},"spinach":{"impact":0.54,"replacement":""},"garlic":{"impact":0.57,"replacement":""},"strawberries":{"impact":0.58,"replacement":""},"olives":{"impact":0.63,"replacement":""},"peppers":{"impact":0.66,"replacement":""},"capsicums":{"impact":0.66,"replacement":""},"beans: pinto usa dried":{"impact":0.73,"replacement":""},"soy milk":{"impact":0.75,"replacement":"almond milk"},"runner beans":{"impact":0.75,"replacement":""},"french beans":{"impact":0.75,"replacement":""},"chick peas":{"impact":0.77,"replacement":""},"asparagus":{"impact":0.83,"replacement":""},"peanuts":{"impact":0.83,"replacement":""},"raspberries":{"impact":0.84,"replacement":""},"gooseberries":{"impact":0.84,"replacement":""},"currants":{"impact":0.84,"replacement":""},"sesame seed":{"impact":0.88,"replacement":""},"ginger":{"impact":0.88,"replacement":""},"blueberries":{"impact":0.92,"replacement":""},"cranberries":{"impact":0.92,"replacement":""},"hazelnuts":{"impact":0.97,"replacement":""},"ground nuts":{"impact":0.99,"replacement":""},"lentils":{"impact":1.03,"replacement":""},"pilchard":{"impact":1.1,"replacement":""},"quinoa":{"impact":1.15,"replacement":""},"herring":{"impact":1.16,"replacement":""},"milk":{"impact":1.29,"replacement":"almond milk"},"avocados":{"impact":1.3,"replacement":""},"yoghurt":{"impact":1.31,"replacement":""},"aubergines":{"impact":1.35,"replacement":""},"eggplants":{"impact":1.35,"replacement":""},"sunflower seed":{"impact":1.41,"replacement":""},"cashew nut":{"impact":1.44,"replacement":""},"walnuts":{"impact":1.51,"replacement":""},"pistachios":{"impact":1.53,"replacement":""},"almonds":{"impact":1.54,"replacement":""},"pollock":{"impact":1.6,"replacement":""},"carp":{"impact":1.76,"replacement":""},"mackerel":{"impact":1.8,"replacement":""},"rape seed":{"impact":2.09,"replacement":""},"mustard seed":{"impact":2.09,"replacement":""},"cucumbers":{"impact":2.1,"replacement":""},"gherkins":{"impact":2.1,"replacement":""},"tuna":{"impact":2.15,"replacement":""},"rice":{"impact":2.55,"replacement":""},"whiting":{"impact":2.66,"replacement":""},"duck":{"impact":3.09,"replacement":""},"sea bass":{"impact":3.27,"replacement":""},"haddock":{"impact":3.41,"replacement":""},"eggs":{"impact":3.46,"replacement":""},"salmon":{"impact":3.47,"replacement":""},"fish":{"impact":3.49,"replacement":""},"cod":{"impact":3.51,"replacement":""},"buffalo milk":{"impact":3.57,"replacement":"almond milk"},"chicken":{"impact":3.65,"replacement":""},"lettuce":{"impact":3.7,"replacement":""},"eel":{"impact":3.88,"replacement":""},"kangaroo":{"impact":4.1,"replacement":""},"trout":{"impact":4.2,"replacement":""},"rabbit":{"impact":4.7,"replacement":""},"cream":{"impact":5.64,"replacement":""},"pork":{"impact":5.77,"replacement":""},"ling common":{"impact":6.45,"replacement":""},"pomfret":{"impact":6.63,"replacement":""},"rock fish":{"impact":6.94,"replacement":""},"squid":{"impact":7.13,"replacement":""},"cuttlefish":{"impact":7.13,"replacement":""},"octopus":{"impact":7.13,"replacement":""},"shrimp":{"impact":7.8,"replacement":""},"prawns":{"impact":7.8,"replacement":""},"turkey":{"impact":7.17,"replacement":""},"diamond fish":{"impact":8.33,"replacement":""},"rhombus":{"impact":8.41,"replacement":""},"cheese":{"impact":8.55,"replacement":""},"butter":{"impact":9.25,"replacement":"oil"},"mussels":{"impact":9.51,"replacement":""},"hake":{"impact":9.77,"replacement":""},"porbeagle":{"impact":11.44,"replacement":""},"shark mako":{"impact":11.5,"replacement":""},"anglerfish":{"impact":12.29,"replacement":""},"swordfish":{"impact":12.84,"replacement":""},"megrim":{"impact":14.15,"replacement":""},"turbot":{"impact":14.51,"replacement":""},"sole":{"impact":20.86,"replacement":""},"lamb":{"impact":25.58,"replacement":"lentils"},"beef":{"impact":26.61,"replacement":"lentils"},"lobster":{"impact":27.8,"replacement":""},"buffalo":{"impact":60.43,"replacement":""}}

test_food_data = {
  "apple": {
  	"impact": 1.0,
  	"replacement": ""
  },
  "beef": {
  	"impact": 10.5,
  	"replacement": "lentils"
  },
  "flour": {
  	"impact": 0.5,
  	"replacement": ""
  },
  "butter": {
  	"impact": 9.4,
  	"replacement": "oil"
  },
  "egg": {
  	"impact": 5.5,
  	"replacement": "flax egg"
  },
  "sugar": {
  	"impact": 3.0,
  	"replacement": ""
  },
  "oil": {
  	"impact": 12.1,
  	"replacement": ""
  },
  "parsnip": {
  	"impact": 0.5,
  	"replacement": ""
  }
};

unit_to_kg = {
	"kg": 1.0,
	"g": 0.01,
	"l": 1.0,
	"ml": 0.001
};

individual_to_kg = {
	"egg": 0.05,
	"eggs": 0.05,
	"lemon": 0.1
}

sumImpact = 0.0
maxImpact = 0.0
maxImpactFood = ''

// Inject the payload.js script into the current tab after the popup has loaded
window.addEventListener('load', function (evt) {
	chrome.extension.getBackgroundPage().chrome.tabs.executeScript(null, {
		file: 'payload.js'
	});
});

// Listen to messages from the payload.js script and write to popup.html
chrome.runtime.onMessage.addListener(function (message) {
	type = message[0]
	message = message[1]

	if (type == 'ingredient') {
		addIngredient(message)
	} else if (type == 'title') {
		setTitle(message)
	} else if (type == 'end') {
	    setTotalImpact()
		colorWorstIngredient()
		suggestReplacement()
	}
});

function setTotalImpact() {
    costTable = document.getElementById('cost_table')
    costTableBody = document.createElement('tbody')
    costRow = createCostRow('total', sumImpact)
    costTableBody.appendChild(costRow)
    costTable.appendChild(costTableBody)
}

function colorWorstIngredient() {
	worseIngredientRow = document.getElementById(maxImpactFood)
	worseIngredientRow.style.color = "#7F0000"
	worseIngredientRow.style.fontWeight = "bold"
	worseIngredientRow.style.outline = "thin solid"
}

function suggestReplacement() {
	replacementFood = food_data[maxImpactFood].replacement
	replacementText = '<br>'
	replacementText += 'How about '
	replacementText += replacementFood
	replacementText += ' instead of '
	replacementText += maxImpactFood
	replacementText += ', my Dear?'

	if (replacementFood != '') {
		replacementDiv = document.getElementById('replacement_suggestion')
		replacementDiv.innerHTML = replacementText
	}
}

function setTitle(message) {
	recipeTitle = document.getElementById('recipe_name')
	recipeTitle.innerHTML = message
}

function addIngredient(message) {
	costTable = document.getElementById('cost_table')
	costTableBody = document.createElement('tbody')

	amountReturn = getFirstAmount(message)
	firstAmount = amountReturn[0]
	firstAmountUnit = amountReturn[1]
	foodName = getFirstFood(message)

	if (!(foodUnitPairIsValid(foodName, firstAmountUnit))) { // Is unit valid or if not, is food measured in individuals?
		foodName = noInfoFoodName
	}
	
	if (foodName != noInfoFoodName) {
		impactValue = getImpact(foodName, firstAmount, firstAmountUnit)
		sumImpact += impactValue
		if (impactValue > maxImpact) { // Problem if ingredient appears more than once!
			maxImpact = impactValue
			maxImpactFood = foodName
		}

		costRow = createCostRowFields(foodName, firstAmount, firstAmountUnit, impactValue)
		costTableBody.appendChild(costRow)
		costTable.appendChild(costTableBody)
	}
}

function getFirstFood(message) {
	words = message.split(/[\s,\(\\/)]+/)

	foodName = noInfoFoodName
	for (i = 0; i < words.length; i += 1) {
		if ((words[i] in food_data)) {
			foodName = words[i]
			break
		} else if (words[i].slice(0, -1) in food_data) { // Plural s
			foodName = words[i].slice(0, -1)
			break
		} else if (words[i] + 's' in food_data) { // Plural s
		    foodName = words[i]
		    break
		}
	}

	return foodName
}

function foodUnitPairIsValid(foodName, unit) {
	// foodName is already valid
	if (unit in unit_to_kg) {
		return true
	}
	if (foodName in individual_to_kg) {
		return true
	}
	return false
}

function getImpact(foodName, amount, unit) {
	impactPerKg = food_data[foodName].impact

	// We made sure it's valid
	if (unit in unit_to_kg) {
		unitInKg = amount * unit_to_kg[unit]
	} else {
		unitInKg = amount * individual_to_kg[foodName]
	}

	totalImpact = impactPerKg * unitInKg
	return totalImpact
}

function getFirstAmount(message) {
	has_integer_regex = /\d/
	integer_regex = /\d+/
	unit_regex = /\d+([a-zA-Z½]*)[\s,\(\)\/]+/


	if (has_integer_regex.test(message)) {
		firstAmount = message.match(integer_regex)[0]
		firstAmountUnit = message.match(unit_regex)[1] // Matching group
	} else {
		firstAmount = ""
		firstAmountUnit = ""
	}

	return [firstAmount, firstAmountUnit]
}

function createCostRow(ingredientText, impactText) {
	costRow = document.createElement('tr')

	ingredientData = document.createElement('td')
	ingredient = document.createTextNode(ingredientText)
	ingredientData.appendChild(ingredient)
	costRow.appendChild(ingredientData)

	impactData = document.createElement('td')
	impact = document.createTextNode(impactText)
	impactData.appendChild(impact)
	costRow.appendChild(impactData)
	costRow.id = foodName

    return costRow
}

function createCostRowFields(foodName, firstAmount, firstAmountUnit, impactValue) {
	ingredientText = firstAmount + firstAmountUnit + " " + foodName
	impactText = impactValue.toFixed(3)

	return createCostRow(ingredientText, impactText)
}